<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Crear Encuesta</title>
    <link rel="stylesheet" href="crear.css">
    <style>
        .error-text {
            color: red;
            font-size: 0.9rem;
            margin-top: -5px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h2>Crear Encuesta</h2>

        <form id="formEncuesta" action="procesar_crear.php" method="POST" novalidate>
            <label for="titulo">Título de la encuesta:</label>
            <input type="text" id="titulo" name="titulo" required>
            <div id="error-titulo" class="error-text"></div>

            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" name="descripcion" required>
            <div id="error-descripcion" class="error-text"></div>

            <div id="preguntas-container"></div>

            <button type="button" onclick="agregarPregunta()">+ Añadir Pregunta</button>
            <br><br>

            <button type="submit">Guardar Encuesta</button>
        </form>

        <a class="volver" href="../inicio/index.php">Volver al inicio</a>
    </div>

    <script>
        let contadorPreguntas = 0;

        function agregarPregunta() {
            contadorPreguntas++;
            const container = document.getElementById('preguntas-container');

            const preguntaDiv = document.createElement('div');
            preguntaDiv.className = 'pregunta';
            preguntaDiv.dataset.numero = contadorPreguntas;

            preguntaDiv.innerHTML = `
                <h4>Pregunta ${contadorPreguntas}</h4>
                <input type="text" name="preguntas[]" required placeholder="Texto de la pregunta">
                <div class="error-text"></div>

                <div class="respuestas">
                    ${crearOpcionInput(contadorPreguntas)}
                    ${crearOpcionInput(contadorPreguntas)}
                </div>

                <button type="button" onclick="agregarOpcion(this)">+ Añadir Opción</button>
                <button type="button" class="btn-pequeno" onclick="eliminarPregunta(this)">Eliminar Pregunta</button>
            `;

            container.appendChild(preguntaDiv);
            actualizarNumeracion();
        }

        function crearOpcionInput(preguntaId) {
            return `
                <div class="opcion">
                    <input type="text" name="respuestas_${preguntaId}[]" required placeholder="Respuesta">
                    <div class="error-text"></div>
                    <button type="button" class="btn-pequeno" onclick="eliminarOpcion(this)">Eliminar</button>
                </div>
            `;
        }

        function agregarOpcion(boton) {
            const preguntaDiv = boton.parentElement;
            const respuestasDiv = preguntaDiv.querySelector('.respuestas');
            const preguntaId = preguntaDiv.dataset.numero;
            const total = respuestasDiv.querySelectorAll('.opcion').length;

            if (total >= 4) {
                alert("No se pueden añadir más de 4 respuestas.");
                return;
            }

            const nuevaOpcion = document.createElement('div');
            nuevaOpcion.className = 'opcion';
            nuevaOpcion.innerHTML = `
                <input type="text" name="respuestas_${preguntaId}[]" required placeholder="Respuesta">
                <div class="error-text"></div>
                <button type="button" class="btn-pequeno" onclick="eliminarOpcion(this)">Eliminar</button>
            `;

            respuestasDiv.appendChild(nuevaOpcion);
            actualizarNumeracionRespuestas(respuestasDiv);
        }

        function eliminarOpcion(boton) {
            const respuestasDiv = boton.parentElement.parentElement;
            const total = respuestasDiv.querySelectorAll('.opcion').length;

            if (total <= 2) {
                alert("Cada pregunta debe tener al menos 2 respuestas.");
                return;
            }

            boton.parentElement.remove();
            actualizarNumeracionRespuestas(respuestasDiv);
        }

        function eliminarPregunta(boton) {
            boton.parentElement.remove();
            actualizarNumeracion();
        }

        function actualizarNumeracion() {
            const preguntas = document.querySelectorAll('.pregunta');
            preguntas.forEach((pregunta, index) => {
                const nuevoNum = index + 1;
                pregunta.dataset.numero = nuevoNum;
                pregunta.querySelector('h4').textContent = `Pregunta ${nuevoNum}`;

                const inputs = pregunta.querySelectorAll('.respuestas input');
                inputs.forEach(input => {
                    input.name = `respuestas_${nuevoNum}[]`;
                });

                actualizarNumeracionRespuestas(pregunta.querySelector('.respuestas'));
            });
        }

        function actualizarNumeracionRespuestas(respuestasDiv) {
            const respuestas = respuestasDiv.querySelectorAll('.opcion input');
            respuestas.forEach((input, index) => {
                input.placeholder = `Respuesta ${index + 1}`;
            });
        }

        document.getElementById('formEncuesta').addEventListener('submit', function (e) {
            let valido = true;

            document.querySelectorAll('.error-text').forEach(el => el.textContent = '');

            const titulo = document.getElementById('titulo').value.trim();
            const descripcion = document.getElementById('descripcion').value.trim();
            const preguntas = document.querySelectorAll('.pregunta');

            if (titulo === '') {
                document.getElementById('error-titulo').textContent = "El título no puede estar vacío.";
                valido = false;
            }

            if (descripcion === '') {
                document.getElementById('error-descripcion').textContent = "La descripción no puede estar vacía.";
                valido = false;
            }

            if (preguntas.length === 0) {
                alert("Debes añadir al menos una pregunta.");
                valido = false;
            }

            preguntas.forEach((pregunta, i) => {
                const inputPregunta = pregunta.querySelector('input[name="preguntas[]"]');
                const textoPregunta = inputPregunta.value.trim();
                const errorPregunta = inputPregunta.nextElementSibling;

                if (textoPregunta === '') {
                    errorPregunta.textContent = `La pregunta ${i + 1} no puede estar vacía.`;
                    valido = false;
                }

                const respuestas = pregunta.querySelectorAll('.respuestas .opcion');
                if (respuestas.length < 2) {
                    alert(`La pregunta ${i + 1} debe tener al menos 2 respuestas.`);
                    valido = false;
                }

                respuestas.forEach((opcion, j) => {
                    const inputRespuesta = opcion.querySelector('input');
                    const errorRespuesta = inputRespuesta.nextElementSibling;
                    if (inputRespuesta.value.trim() === '') {
                        errorRespuesta.textContent = `La respuesta ${j + 1} de la pregunta ${i + 1} está vacía.`;
                        valido = false;
                    }
                });
            });

            if (!valido) {
                e.preventDefault();
            }
        });
    </script>
</body>

</html>
